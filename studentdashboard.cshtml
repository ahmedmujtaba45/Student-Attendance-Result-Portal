<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard | Student Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* Particle background */
    body {
        font-family: 'Segoe UI', sans-serif;
        background:rgb(35, 117, 175);
        overflow-x: hidden;
        position: relative;
        min-height: 100vh;
    }
    canvas#particles {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        z-index:-1;
    }

    /* Navbar */
    .navbar { background-color: rgba(58, 123, 213,0.95); }
    .navbar-brand { color: #fff !important; }
    .btn-light { color: #0A3D62 !important; }

    /* Cards */
    .card {
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(8px);
    }
    .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 28px rgba(0,0,0,0.3);
    }
    .card-title { color: #0A3D62; font-weight: bold; }

    /* Sections */
    .section { display: none; margin-top: 20px; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    /* Tables */
    table { background: rgba(255,255,255,0.95); }
    th, td { text-align: center; vertical-align: middle; }
    
    /* Loading Spinner */
    .spinner-border { width: 3rem; height: 3rem; }

</style>
</head>
<body>

<canvas id="particles"></canvas>

<script>
// ---------- LOGIN VALIDATION ----------
let studentID = localStorage.getItem("StudentID");
// We grab the name from storage initially, but we will refresh it via API to fix the "Teacher Name" bug
let studentName = localStorage.getItem("Name"); 

if (!studentID) window.location.href = "login.html";
</script>

<nav class="navbar navbar-dark shadow-sm">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-light me-3 fw-bold border-0" onclick="openProfileModal()">
                ðŸ‘¤ My Profile
            </button>
            <span class="navbar-brand mb-0 h1">Student Dashboard</span>
        </div>
        
        <div class="d-flex align-items-center">
            <span class="text-white me-3 d-none d-md-block">Welcome <span id="studentNameDisplay"></span></span>
            <a href="login.html" class="btn btn-light btn-sm fw-bold" onclick="logout()">Logout</a>
        </div>
    </div>
</nav>

<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">My Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm">
            <div class="mb-3">
                <label class="form-label fw-bold">Student ID</label>
                <input type="text" class="form-control bg-light" id="profID" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Full Name</label>
                <input type="text" class="form-control" id="profName">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Email</label>
                <input type="email" class="form-control" id="profEmail">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Department</label>
                <input type="text" class="form-control bg-light" id="profDept" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Password</label>
                <input type="text" class="form-control" id="profPass">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
      </div>
    </div>
  </div>
</div>

<div class="container mt-5">
    <h3 class="text-white mb-4">Student Dashboard</h3>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-4 text-center" onclick="showSection('myCourses')">
                <h5 class="card-title">My Courses</h5>
                <p class="mb-0 text-muted">View your enrolled courses</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 text-center" onclick="showSection('attendance')">
                <h5 class="card-title">My Attendance</h5>
                <p class="mb-0 text-muted">View your attendance records</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4 text-center" onclick="showSection('results')">
                <h5 class="card-title">My Results</h5>
                <p class="mb-0 text-muted">View your grades</p>
            </div>
        </div>
    </div>

    <div class="bg-light bg-opacity-75 rounded p-4 mt-4 shadow-sm" id="mainContainer" style="display:none;">
        
        <div id="myCourses" class="section">
            <h4 class="text-primary border-bottom pb-2">My Courses</h4>
            <div id="coursesTable" class="mt-3">
                <div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
        </div>

        <div id="attendance" class="section">
            <h4 class="text-primary border-bottom pb-2">My Attendance</h4>
            <div id="attendanceTable" class="mt-3">
                <div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
        </div>

        <div id="results" class="section">
            <h4 class="text-primary border-bottom pb-2">My Results</h4>
            <div id="resultsTable" class="mt-3">
                <div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// INITIAL DISPLAY
document.getElementById("studentNameDisplay").innerText = studentName;

// FIX FOR WRONG NAME: Fetch fresh profile data immediately to update the name
getFreshProfileName();

function getFreshProfileName() {
    fetch(`fetch_student_profile.php?StudentID=${studentID}`)
    .then(res => res.json())
    .then(data => {
        if(data && !data.error) {
            // Update UI
            document.getElementById("studentNameDisplay").innerText = data.Name;
            // Update Local Storage so it's correct next time
            localStorage.setItem("Name", data.Name);
        }
    });
}

// LOGOUT
function logout() {
    localStorage.clear();
}

// SHOW SECTIONS
function showSection(section) {
    document.getElementById('mainContainer').style.display = 'block';
    document.querySelectorAll('.section').forEach(sec => sec.style.display='none');
    document.getElementById(section).style.display='block';

    if(section === 'myCourses') loadCourses();
    else if(section === 'attendance') loadAttendance();
    else if(section === 'results') loadResults();
}

// --- PROFILE FUNCTIONS ---
function openProfileModal() {
    fetch(`fetch_student_profile.php?StudentID=${studentID}`)
    .then(res => res.json())
    .then(data => {
        if(data.error) { Swal.fire('Error', 'Could not load profile', 'error'); return; }
        
        document.getElementById('profID').value = data.StudentID;
        document.getElementById('profName').value = data.Name;
        document.getElementById('profEmail').value = data.Email;
        
        // Derive Department from ID or if you have a Dept column. 
        // Logic: Extract text prefix (e.g. BSE from BSE231012)
        let deptPrefix = data.StudentID.replace(/[^A-Za-z]/g, '');
        document.getElementById('profDept').value = deptPrefix || "Unknown"; 

        document.getElementById('profPass').value = data.Password;
        
        new bootstrap.Modal(document.getElementById('profileModal')).show();
    });
}

function updateProfile() {
    const payload = {
        StudentID: document.getElementById('profID').value,
        Name: document.getElementById('profName').value,
        Email: document.getElementById('profEmail').value,
        Password: document.getElementById('profPass').value
    };

    fetch('update_student_profile.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            Swal.fire('Success', 'Profile Updated!', 'success').then(() => {
                localStorage.setItem("Name", payload.Name);
                document.getElementById("studentNameDisplay").innerText = payload.Name;
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    });
}

// 1. LOAD COURSES (Tabular Form)
function loadCourses() {
    fetch(`fetch_student_courses.php?StudentID=${studentID}`)
    .then(res => res.json())
    .then(data => {
        if (!data || data.length === 0 || data.error) {
            document.getElementById('coursesTable').innerHTML = `<div class='alert alert-warning'>No courses found or not registered.</div>`;
            return;
        }

        let html = `
        <table class="table table-hover table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th scope="col" style="width: 10%">#</th>
                    <th scope="col">Course Name</th>
                    <th scope="col" style="width: 20%">Course ID</th>
                </tr>
            </thead>
            <tbody>
        `;

        data.forEach((course, i) => {
            html += `
            <tr>
                <td>${i+1}</td>
                <td class="fw-bold text-start ps-5">${course.CourseName}</td>
                <td><span class="badge bg-primary">${course.CourseID}</span></td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('coursesTable').innerHTML = html;
    })
    .catch(err => {
        document.getElementById('coursesTable').innerHTML = `<div class='alert alert-danger'>Error loading data.</div>`;
    });
}

// 2. LOAD ATTENDANCE (Tabular Form + Serial Numbers)
function loadAttendance() {
    fetch(`fetch_student_attendance.php?StudentID=${studentID}`)
    .then(res => res.json())
    .then(data => {
        if (!data || data.length === 0) {
            document.getElementById('attendanceTable').innerHTML = `<div class='alert alert-info'>No attendance records found.</div>`;
            return;
        }

        let html = `
        <table class="table table-hover table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Subject</th>
                    <th scope="col">Date</th>
                    <th scope="col">Time</th>
                    <th scope="col">Status</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Added 'i' index for Serial Numbers
        data.forEach((row, i) => {
            let badgeClass = row.Status === 'Present' ? 'bg-success' : (row.Status === 'Absent' ? 'bg-danger' : 'bg-warning text-dark');
            html += `
            <tr>
                <td>${i + 1}</td>
                <td class="text-start ps-4">${row.CourseName}</td>
                <td>${row.Date}</td>
                <td>${row.Time}</td>
                <td><span class="badge ${badgeClass}">${row.Status}</span></td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('attendanceTable').innerHTML = html;
    })
    .catch(err => {
        document.getElementById('attendanceTable').innerHTML = `<div class='alert alert-danger'>Error loading data.</div>`;
    });
}

// 3. LOAD RESULTS (Tabular Form + Serial Numbers)
function loadResults() {
    fetch(`fetch_student_results.php?StudentID=${studentID}`)
    .then(res => res.json())
    .then(data => {
        if (!data || data.length === 0) {
            document.getElementById('resultsTable').innerHTML = `<div class='alert alert-info'>No results found.</div>`;
            return;
        }

        let html = `
        <table class="table table-hover table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Subject</th>
                    <th scope="col">Marks</th>
                    <th scope="col">Grade</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Added 'i' index for Serial Numbers
        data.forEach((row, i) => {
            let gradeColor = 'text-dark';
            if(row.Grade === 'A' || row.Grade === 'A+') gradeColor = 'text-success';
            if(row.Grade === 'F') gradeColor = 'text-danger';

            html += `
            <tr>
                <td>${i + 1}</td>
                <td class="text-start ps-4">${row.CourseName}</td>
                <td>${row.Marks}</td>
                <td class="fw-bold ${gradeColor}">${row.Grade}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('resultsTable').innerHTML = html;
    })
    .catch(err => {
        document.getElementById('resultsTable').innerHTML = `<div class='alert alert-danger'>Error loading data.</div>`;
    });
}
</script>

<script>
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let particlesArray = [];
class Particle {
    constructor() {
        this.x = Math.random()*canvas.width;
        this.y = Math.random()*canvas.height;
        this.size = Math.random()*3+1;
        this.speedX = Math.random()*1-0.5;
        this.speedY = Math.random()*1-0.5;
        this.color = 'rgba(255,255,255,0.6)';
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        if(this.x<0 || this.x>canvas.width) this.speedX*=-1;
        if(this.y<0 || this.y>canvas.height) this.speedY*=-1;
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
        ctx.fill();
    }
}
function init() {
    particlesArray=[];
    for(let i=0;i<100;i++) particlesArray.push(new Particle());
}
function animate() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particlesArray.forEach(p => { p.update(); p.draw(); });
    requestAnimationFrame(animate);
}
init();
animate();
window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; init(); });
</script>

</body>
</html>